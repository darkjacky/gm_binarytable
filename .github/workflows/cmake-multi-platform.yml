name: Build gmsv_binarytable

on:
  push:
  pull_request:

jobs:
  build-linux:
    name: Build Linux (32 + 64)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      # ----------------------------
      # Install Premake5 beta7
      # ----------------------------
      - name: Cache Premake5
        id: cache-premake
        uses: actions/cache@v4
        with:
          path: premake5
          key: premake5-beta7-linux

      - name: Download Premake5
        if: steps.cache-premake.outputs.cache-hit != 'true'
        run: |
          curl -L \
            https://github.com/premake/premake-core/releases/download/v5.0.0-beta7/premake-5.0.0-beta7-linux.tar.gz \
            -o premake.tar.gz
          tar -xzf premake.tar.gz
          chmod +x premake5

      # ----------------------------
      # Linux toolchains
      # ----------------------------
      - name: Install 32-bit toolchain
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y gcc-multilib g++-multilib

      # ----------------------------
      # Generate + Build
      # ----------------------------
      - name: Generate Makefiles
        run: ./premake5 gmake

      - name: Build all targets
        working-directory: projects/linux
        run: make -j$(nproc)

      # ----------------------------
      # Upload artifacts
      # ----------------------------
      - name: Upload Linux 32-bit
        uses: actions/upload-artifact@v4
        with:
          name: gmsv_binarytable_linux32
          path: build/gmsv_binarytable_linux.dll

      - name: Upload Linux 64-bit
        uses: actions/upload-artifact@v4
        with:
          name: gmsv_binarytable_linux64
          path: build/gmsv_binarytable_linux64.dll


  build-windows:
    name: Build Windows (32 + 64)
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      # ----------------------------
      # Install Premake5 beta7
      # ----------------------------
      - name: Cache Premake5
        id: cache-premake
        uses: actions/cache@v4
        with:
          path: premake5.exe
          key: premake5-beta7-windows

      - name: Download Premake5
        if: steps.cache-premake.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          Invoke-WebRequest `
            https://github.com/premake/premake-core/releases/download/v5.0.0-beta7/premake-5.0.0-beta7-windows.zip `
            -OutFile premake.zip
          Expand-Archive -Force premake.zip -DestinationPath .
          Remove-Item premake.zip

      # ----------------------------
      # Generate + Build
      # ----------------------------
      - name: Generate Visual Studio solution
        run: ./premake5.exe vs2022

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Build Win32
        shell: pwsh
        run: |
          msbuild projects/windows/gmsv_binarytable_32.vcxproj `
            /p:Configuration=Release `
            /p:Platform=Win32

      - name: Build Win64
        shell: pwsh
        run: |
          msbuild projects/windows/gmsv_binarytable_64.vcxproj `
            /p:Configuration=Release `
            /p:Platform=x64

      # ----------------------------
      # Upload artifacts
      # ----------------------------
      - name: Upload Windows 32-bit
        uses: actions/upload-artifact@v4
        with:
          name: gmsv_binarytable_win32
          path: build/gmsv_binarytable_win32.dll

      - name: Upload Windows 64-bit
        uses: actions/upload-artifact@v4
        with:
          name: gmsv_binarytable_win64
          path: build/gmsv_binarytable_win64.dll
