name: Build (Premake)

on:
  push:
  pull_request:

jobs:
  build:
    name: Build (${{ matrix.os }} - ${{ matrix.arch }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # ----------------------
          # Linux
          # ----------------------
          - os: ubuntu-latest
            arch: x64
            premake_os: linux
            premake_file: premake-5.0.0-beta7-linux.tar.gz

          - os: ubuntu-latest
            arch: x86
            premake_os: linux
            premake_file: premake-5.0.0-beta7-linux.tar.gz
            flags: "-m32"

          # ----------------------
          # Windows
          # ----------------------
          - os: windows-latest
            arch: x64
            premake_os: windows
            premake_file: premake-5.0.0-beta7-windows.zip
            vs_platform: x64

          - os: windows-latest
            arch: x86
            premake_os: windows
            premake_file: premake-5.0.0-beta7-windows.zip
            vs_platform: Win32

    steps:
      - uses: actions/checkout@v4

      # -------------------------------------------------------
      # Install Premake5 beta7
      # -------------------------------------------------------
      - name: Download Premake5 (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          curl -L "https://github.com/premake/premake-core/releases/download/v5.0.0-beta7/${{ matrix.premake_file }}" -o premake.tar.gz
          tar -xzf premake.tar.gz
          chmod +x premake5

      - name: Download Premake5 (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://github.com/premake/premake-core/releases/download/v5.0.0-beta7/${{ matrix.premake_file }}" -OutFile premake.zip
          Expand-Archive premake.zip -DestinationPath .
          Rename-Item -Path premake5.exe -NewName premake5.exe

      # -------------------------------------------------------
      # LINUX BUILDS
      # -------------------------------------------------------
      - name: Install 32-bit toolchain (Linux only)
        if: runner.os == 'Linux' && matrix.arch == 'x86'
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y gcc-multilib g++-multilib

      - name: Generate Makefiles (Linux)
        if: runner.os == 'Linux'
        run: |
          ./premake5 gmake2

      - name: Build (Linux)
        if: runner.os == 'Linux'
        run: |
          cd build
          make config=release CFLAGS="${{ matrix.flags }}" CXXFLAGS="${{ matrix.flags }}"

      # -------------------------------------------------------
      # WINDOWS BUILDS
      # -------------------------------------------------------
      - name: Generate VS project (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          ./premake5.exe vs2022

      - name: Build (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          msbuild build/gm_binarytable.vcxproj /p:Configuration=Release /p:Platform=${{ matrix.vs_platform }}

      # -------------------------------------------------------
      # Upload artifacts
      # -------------------------------------------------------
      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: gm_binarytable_${{ matrix.os }}_${{ matrix.arch }}
          path: |
            build/bin/**/*
